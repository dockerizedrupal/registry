server {
  listen 443 ssl;
  server_name <%= @server_name %>;

  root /var/www;

  location /ca {
    include fastcgi_params;

    fastcgi_pass unix:/var/run/php5-fpm.sock;

    fastcgi_param SCRIPT_FILENAME /var/www/ca.php;
  }

  location / {
    auth_basic "Registry Authentication";
    auth_basic_user_file /registry/.htpasswd;

    index index.php;

    try_files $uri $uri/ =404;

    location ~ index\.php {
      include fastcgi_params;

      fastcgi_pass unix:/var/run/php5-fpm.sock;

      fastcgi_param SCRIPT_FILENAME /var/www/index.php;
    }
  }

  location /v1 {
    auth_basic "Registry Authentication";
    auth_basic_user_file /registry/.htpasswd;

    proxy_pass http://registry_v1;
  }

  location /_ping {
    auth_basic off;

    proxy_pass http://registry_v1;
  }

  location /v1/_ping {
    auth_basic off;

    proxy_pass http://registry_v1;
  }

  location /v2 {
    auth_basic "Registry Authentication";
    auth_basic_user_file /registry/.htpasswd;

    add_header 'Docker-Distribution-Api-Version:' 'registry/2.0' always;

    proxy_pass http://registry_v2;
  }
}

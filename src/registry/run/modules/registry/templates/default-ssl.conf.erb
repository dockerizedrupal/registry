proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header Authorization "";

proxy_read_timeout 900s;

upstream registry {
  server localhost:5000;
}

server {
  listen 443 ssl;
  server_name <%= @server_name %>;

  root /var/www;

  location /ca {
    include fastcgi_params;

    fastcgi_pass unix:/var/run/php5-fpm.sock;

    fastcgi_param SCRIPT_FILENAME /var/www/ca.php;
  }

  location @registry {
    proxy_pass http://registry;
  }

  location / {
    auth_basic "Restricted";
    auth_basic_user_file /registry/.htpasswd;

    index index.php;

    try_files $uri $uri/ @registry;

    location ~ index\.php {
      include fastcgi_params;

      fastcgi_pass unix:/var/run/php5-fpm.sock;

      fastcgi_param SCRIPT_FILENAME /var/www/index.php;
    }
  }

  location /_ping {
    auth_basic off;

    proxy_pass http://registry;
  }

  location /v1/_ping {
    auth_basic off;

    proxy_pass http://registry;
  }
}

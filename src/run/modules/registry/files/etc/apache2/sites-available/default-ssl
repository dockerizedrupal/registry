<IfModule mod_ssl.c>
  <VirtualHost *:443>
    ServerName registry.example.com

    Header set Host "registry.example.com"
    RequestHeader set X-Forwarded-Proto "https"

    ProxyRequests off
    ProxyPreserveHost on
    ProxyPass / http://127.0.0.1:5000/
    ProxyPassReverse / http://127.0.0.1:5000/

    <Location />
      Order deny,allow
      Allow from all

      AuthName "Registry Authentication"
      AuthType basic
      AuthUserFile "/etc/apache2/htpasswd/registry-htpasswd"
      Require valid-user
    </Location>

    # Allow ping and users to run unauthenticated.
    <Location /v1/_ping>
      Satisfy any
      Allow from all
    </Location>

    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
  </VirtualHost>
</IfModule>
